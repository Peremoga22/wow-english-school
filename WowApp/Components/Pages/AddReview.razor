@page "/add-review"
@using System.ComponentModel.DataAnnotations
@inject ReviewService ReviewService
@inject NavigationManager Nav
@inject AppointmentNotifier _notification
@rendermode InteractiveServer

<PageTitle>Додати відгук</PageTitle>

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-white p-2 mb-4 rounded shadow-sm">
            <li class="breadcrumb-item">
                <a href="/reviews" class="bread-link">@SharedResource.TextAddReview_1</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">@SharedResource.TextAddReview_2</li>
        </ol>
    </nav>

    <div class="text-center mb-4">
        <h2 class="courses-title mb-2">@SharedResource.TextAddReview_2</h2>
        <p class="ec-subtitle mx-auto">@SharedResource.TextAddReview_3 💛</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-6 col-xl-5">
            <div class="review-card p-4 bg-white rounded-4 border text-center shadow-sm">

                <EditForm Model="@form" OnValidSubmit="SubmitAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="form-floating mb-3 text-start">
                        <InputText class="form-control" @bind-Value="form.ClientName"  />
                        <label>@SharedResource.TextAddReview_4</label>
                    </div>

                    <div class="form-floating mb-3 text-start">
                        <InputTextArea class="form-control" @bind-Value="form.Content"  style="height: 140px;" />
                        <label>@SharedResource.TextAddReview_5</label>
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label text-muted mb-1">@SharedResource.TextAddReview_6</label>

                        <div class="star-group">
                            @for (var i = 1; i <= 5; i++)
                            {
                                var r = i;

                                <button type="button"
                                        class="star-btn @(form.Rating >= r ? "active" : "")"
                                        aria-label="Оцінка @r"
                                        @onclick="() => SetRating(r)">
                                    ★
                                </button>
                            }
                        </div>

                        <div class="text-muted small mt-2 text-center">
                            @SharedResource.TextAddReview_7 <b>@(form.Rating == 0 ? "—" : form.Rating)</b> / 5
                        </div>

                        <ValidationMessage For="() => form.Rating" />
                    </div>



                    <button class="btn ec-btn-primary w-100 py-2" type="submit" disabled="@isSending">
                        @(isSending? @SharedResource.TextAddReview_8: @SharedResource.TextAddReview_9)
                    </button>
                </EditForm>

                @if (!string.IsNullOrWhiteSpace(success))
                {
                    <div class="alert alert-success mt-3 mb-0 text-start">@success</div>
                }

                <div class="alert alert-warning mt-3 mb-0 text-start">
                    @SharedResource.TextAddReview_10
                </div>

            </div>
        </div>
    </div>
</div>

@code {
    [CascadingParameter] public MainLayout? Layout { get; set; }
    private bool isSending;
    private string? success;
    private int hoverRating = 0;
    private Review form = new();

    protected override Task OnInitializedAsync()
    {
        form.Rating = 0;
        return Task.CompletedTask;
    }

    private void SetRating(int value)
    {
        form.Rating = value; 
    }

    private async Task SubmitAsync()
    {
        isSending = true;

        var review = new Review
        {
            ClientName = form.ClientName,
            Content = form.Content,
            Rating = form.Rating,
            ReviewDate = DateOnly.FromDateTime(DateTime.Today)
        };

        await ReviewService.SaveServiceAsync(review);
        await _notification.NotifyNewReviewAsync(review);

        success = $"{@SharedResource.TextAddReview_11} ❤️";
        form = new Review { Rating = 0 };
        hoverRating = 0;
        isSending = false;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender) return;

        Layout?.SetSeo(
            "Послуги — English Club WOW | Стрий та онлайн",
            "Групові та індивідуальні заняття з англійської для дітей і дорослих. Speaking Club, підготовка до іспитів, онлайн/офлайн навчання."
        );
    }
}




