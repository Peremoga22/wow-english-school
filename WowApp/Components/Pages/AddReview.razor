@page "/add-review"
@using System.ComponentModel.DataAnnotations
@inject ReviewService ReviewService
@inject NavigationManager Nav
@rendermode InteractiveServer

<PageTitle>Додати відгук</PageTitle>

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-white p-2 mb-4 rounded shadow-sm">
            <li class="breadcrumb-item">
                <a href="/reviews" class="bread-link">Повернутися назад</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Додати відгук</li>
        </ol>
    </nav>

    <div class="text-center mb-4">
        <h2 class="courses-title mb-2">Додати відгук</h2>
        <p class="ec-subtitle mx-auto">Твоя думка допомагає нам ставати кращими 💛</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-6 col-xl-5">
            <div class="review-card p-4 bg-white rounded-4 border text-center shadow-sm">

                <EditForm Model="@form" OnValidSubmit="SubmitAsync">
                    <DataAnnotationsValidator />
                    <ValidationSummary />

                    <div class="form-floating mb-3 text-start">
                        <InputText class="form-control" @bind-Value="form.ClientName"  />
                        <label>Імʼя та прізвище</label>
                    </div>

                    <div class="form-floating mb-3 text-start">
                        <InputTextArea class="form-control" @bind-Value="form.Content"  style="height: 140px;" />
                        <label>Твій відгук</label>
                    </div>

                    <div class="mb-3 text-start">
                        <label class="form-label text-muted mb-1">Оцініть нас</label>

                        <div class="star-group">
                            @for (var i = 1; i <= 5; i++)
                            {
                                var r = i;

                                <button type="button"
                                        class="star-btn @(form.Rating >= r ? "active" : "")"
                                        aria-label="Оцінка @r"
                                        @onclick="() => SetRating(r)">
                                    ★
                                </button>
                            }
                        </div>

                        <div class="text-muted small mt-2 text-center">
                            Обрано: <b>@(form.Rating == 0 ? "—" : form.Rating)</b> / 5
                        </div>

                        <ValidationMessage For="() => form.Rating" />
                    </div>



                    <button class="btn ec-btn-primary w-100 py-2" type="submit" disabled="@isSending">
                        @(isSending ? "Надсилаю..." : "Надіслати відгук")
                    </button>
                </EditForm>

                @if (!string.IsNullOrWhiteSpace(success))
                {
                    <div class="alert alert-success mt-3 mb-0 text-start">@success</div>
                }

                <div class="alert alert-warning mt-3 mb-0 text-start">
                    Публікація відгуку може бути після модерації.
                </div>

            </div>
        </div>
    </div>
</div>

@code {
    private bool isSending;
    private string? success;
    private int hoverRating = 0;
    private Review form = new();

    protected override Task OnInitializedAsync()
    {
        form.Rating = 0;
        return Task.CompletedTask;
    }

    private void SetRating(int value)
    {
        form.Rating = value; 
    }

    private async Task SubmitAsync()
    {
        isSending = true;

        var review = new Review
        {
            ClientName = form.ClientName,
            Content = form.Content,
            Rating = form.Rating,
            ReviewDate = DateOnly.FromDateTime(DateTime.Today)
        };

        await ReviewService.SaveServiceAsync(review);

        success = "Дякуємо за відгук ❤️";
        form = new Review { Rating = 0 };
        hoverRating = 0;
        isSending = false;
    }
}




