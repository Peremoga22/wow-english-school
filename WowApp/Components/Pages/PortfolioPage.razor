@page "/portfolio"
@using System.Globalization
@implements IDisposable
@inject CultureStateService _cultureStateService
@inject NavigationManager _navigationManager
@inject PortfolioService _portfolioService
@rendermode InteractiveServer
<PageTitle>Портфоліо</PageTitle>
<div class="py-5 ec-bg-soft">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-white p-2 mb-4 rounded shadow-sm">
                <li class="breadcrumb-item">
                    <a href="/" class="bread-link">@SharedResource.TextPortfolio_1</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">@SharedResource.TextPortfolio_2</li>
            </ol>
        </nav>
    </div>
    <section id="courses" class="courses section">

        <div class="container">
            <h3 style="padding-top: 5%;"></h3>
            <!-- SECTION TITLE -->
            <div class="section-title text-center mb-5">
                <h2 class="courses-title">@SharedResource.TextPortfolio_3</h2>
                <p class="courses-desc">
                   @*  Практичні курси та заняття, які допоможуть тобі впевнено використовувати англійську в житті та роботі. *@
                </p>
                <hr/>
            </div>                     
          
            <div class="row g-3 g-lg-4">
                @foreach (var item in filteredPortfolios)
                {
                    <div class="col-12 col-md-6 col-lg-4">
                        <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                            @MediaBlock(item)

                            <div class="card-body d-flex flex-column">
                                <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
                                    <h5 class="fw-bold mb-0 text-truncate" title="@item.TitleCard">@item.TitleCard</h5>                                   
                                </div>

                                <p class="text-muted mb-3" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                                    @item.DescriptionCard
                                </p>

                                <div class="mt-auto d-flex align-items-center justify-content-between">
                                    <div class="mt-auto">
                                        <div class="trainer d-flex align-items-center gap-2 justify-content-center">
                                            <img src="@item.ImgTeacherPath"
                                                 alt="Викладач"
                                                 class="rounded-circle border"
                                                 style="width:36px;height:36px;object-fit:cover;"
                                                 onerror="this.style.display='none'">
                                            <span>@SharedResource.TextPortfolio_4</span>
                                        </div>
                                    </div>                                  
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>


        </div>
    </section>
</div>



@code {

  [CascadingParameter] public MainLayout? Layout { get; set; }
  private List<Portfolio> portfolios = new();
  private List<Portfolio> filteredPortfolios = new();

  protected override async Task OnInitializedAsync()
  {
       _cultureStateService.OnChange += HandleCultureChanged;
                       
       portfolios = await _portfolioService.GetPortfoliosAsync();

       ApplyCulture();
  }

   private void HandleCultureChanged()
   {
       ApplyCulture();
       InvokeAsync(StateHasChanged);
   }

   private void ApplyCulture()
   {
            // false = UA, true = EN
       bool needCulture =
                CultureInfo.CurrentUICulture.TwoLetterISOLanguageName == "en";

       filteredPortfolios = portfolios
                .Where(x => x.IsCulture == needCulture)
                .ToList();
   }

   public void Dispose()
   {
      _cultureStateService.OnChange -= HandleCultureChanged;
   }    

    protected override void OnAfterRender(bool firstRender)
    {
        if (!firstRender) return;

        Layout?.SetSeo(
            "Послуги — English Club W.O.W | Стрий та онлайн",
            "Групові та індивідуальні заняття з англійської для дітей і дорослих. Speaking Club, підготовка до іспитів, онлайн/офлайн навчання."
        );
    }

    private RenderFragment MediaBlock(Portfolio item) => @<div>
   @{
        var hasVideo = !string.IsNullOrWhiteSpace(item.VideoPath);
        var label = string.IsNullOrWhiteSpace(item.Group) ? "Portfolio" : item.Group;
    }

    @if (hasVideo)
    {
                <div class="position-relative">
                    <div class="ratio ratio-16x9">
                        <lite-youtube videoid="@item.VideoPath" title="@item.TitleCard"></lite-youtube>
                    </div>
                    <span class="position-absolute top-0 start-0 m-3 badge rounded-pill text-bg-dark bg-opacity-75">
                        @label
                    </span>
                </div>
    }
    else
   {
                <div class="position-relative" style="height: 220px;">
                        <img src="@item.ImgPath"
                         alt="@item.TitleCard"
                         class="w-100 h-100"
                         style="object-fit:cover;"
                         loading="lazy"
                         onerror="this.src='/images/placeholder.jpg';" />

                    <span class="position-absolute top-0 start-0 m-3 badge rounded-pill text-bg-dark bg-opacity-75">
                        @label
                    </span>
                </div>
    }
    </div>;

}
