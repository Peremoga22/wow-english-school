@page "/callback"
@inject TelegramBotService _telegramBotService
@inject NavigationManager _nav
@inject AuthenticationStateProvider AuthState
@inject AppointmentNotifier _notification
@rendermode InteractiveServer

<PageTitle>Зворотній дзвінок</PageTitle>

<div class="py-5 ec-bg-soft">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-6">

                <div class="bg-white rounded-4 shadow-sm p-4 p-md-5">
                    <h2 class="mb-2">@SharedResource.TextAppointmentCallback_1</h2>
                    <p class="text-muted mb-4">
                        @SharedResource.TextAppointmentCallback_2
                    </p>

                    <EditForm Model="_model"
                              OnValidSubmit="SubmitAsync"
                              FormName="callbackForm">

                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger mb-3" />

                        <div class="mb-3">
                            <label class="form-label">@SharedResource.TextAppointmentCallback_3</label>
                            <InputText class="form-control" @bind-Value="_model.ClientName" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@SharedResource.TextAppointmentCallback_4</label>
                            <InputText class="form-control"
                                       @bind-Value="_model.ClientPhone"
                                       placeholder="+380XXXXXXXXX" />
                        </div>

                        <div class="mb-4">
                            <label class="form-label">@SharedResource.TextAppointmentCallback_5</label>
                            <InputTextArea class="form-control"
                                           @bind-Value="_model.Message"
                                           rows="4" />
                        </div>

                        <button class="btn ec-btn-primary w-100 py-2"
                                type="submit"
                                disabled="@_saving">
                            @if (_saving)
                            {
                                <span>@SharedResource.TextAppointmentCallback_6</span>
                            }
                            else
                            {
                                <span>@SharedResource.TextAppointmentCallback_7</span>
                            }
                        </button>

                        <button class="btn ec-btn-outline-white w-100 py-2 mt-2"
                                type="button"
                                disabled="@_saving"
                                @onclick="GoHome">
                            @SharedResource.TextAppointmentCallback_8
                        </button>
                        @if (!string.IsNullOrWhiteSpace(_okText))
                        {
                            <div class="alert alert-success mt-3 mb-0">@_okText</div>
                        }

                        @if (!string.IsNullOrWhiteSpace(_errText))
                        {
                            <div class="alert alert-danger mt-3 mb-0">@_errText</div>
                        }
                    </EditForm>
                </div>

            </div>
        </div>
    </div>
</div>

@code {
    private  CallbackCreateDto _model = new();
    private bool _saving;   
    private string? _okText;
    private string? _errText;

    private async Task SubmitAsync()
    {
        _okText = null;
        _errText = null;
        _saving = true;

        try
        {
            var id = await _telegramBotService.CreateCallbackAsync(_model);
            _okText = @SharedResource.TextAppointmentCallback_9;
            _model.Id = id;
            await _notification.NotifyNewCallbackAsync(_model);
        }
        catch (Exception ex)
        {
            _errText = @SharedResource.TextAppointmentCallback_10;
            Console.WriteLine(ex);
        }
        finally
        {     
            _model = new();
            _saving = false;
        }               
    }

    private void GoHome()
    {
        _nav.NavigateTo("/");
    }
}
