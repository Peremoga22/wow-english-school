@page "/admin-clients"

@using WowApp.Components.Layout
@inject NavigationManager _navigationManager
@inject TelegramBotService _telegramBotService
@inject IJSRuntime JS
@inject ClientService _clientService
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<PageTitle>Admin clients</PageTitle>

<main class="container my-4">
    <section class="ec-panel">
        <header class="ec-panel__head">
            <div>
                <h1 class="ec-title">Календар записів</h1>
                <p class="ec-subtitle">Перегляньте всі записи за послугами</p>
            </div>
        </header>

        <div class="ec-divider"></div>

        @if (rows is null || rows.Count == 0)
        {
            <div class="text-muted py-3">Немає записів</div>
        }
        else
        {
            <div class="ec-grid">
                @foreach (var appt in rows)
                {
                    var row = MapToCalendarRowDto(appt);

                    <article class="ec-entry">
                        <div class="ec-entry__top">
                            @if (!string.IsNullOrWhiteSpace(row.Group))
                            {
                                <span class="ec-badge">@row.Group</span>
                            }
                            else
                            {
                                <span class="ec-badge ">CALL BACK</span>
                            }

                            <div class="ec-date">
                                <div class="ec-date__d">@row.Date.ToString("dd.MM.yyyy")</div>
                            </div>
                        </div>

                        <div class="ec-entry__body">
                            <div class="ec-client">
                                <div class="ec-client__name">@row.ClientName</div>

                                @if (!string.IsNullOrWhiteSpace(row.ClientPhone))
                                {
                                    <a class="ec-client__phone" href="tel:@row.ClientPhone">@row.ClientPhone</a>
                                }
                            </div>

                            <div class="ec-proc">
                                @if (!string.IsNullOrWhiteSpace(row.TitleCard))
                                {
                                    <div class="ec-proc__title">@row.TitleCard</div>
                                }
                                else
                                {
                                    <div class="ec-proc__title text-muted">Послуга не знайдена</div>
                                }

                                @if (!string.IsNullOrWhiteSpace(row.DescriptionCard))
                                {
                                    <div class="ec-proc__desc">@row.DescriptionCard</div>
                                }
                            </div>
                        </div>

                        <div class="ec-entry__bottom">
                            <div class="ec-price">
                                @if (row.Price.HasValue)
                                {
                                    <span class="duration">@row.Price.Value.ToString("C0", ua)</span>
                                }
                                else
                                {
                                    <span class="text-muted">—</span>
                                }
                            </div>

                            <button class="btn btn-outline-danger btn-sm rounded-pill d-inline-flex align-items-center gap-1"
                                    title="Видалити"
                                    disabled="@deleting.Contains(row.Id)"
                                    @onclick="() => ConfirmAndDeleteAsync(row)">
                                <i class="fa-solid fa-trash" aria-hidden="true"></i>
                                <span>@(deleting.Contains(row.Id) ? "Видаляю..." : "Видалити")</span>
                            </button>
                        </div>
                    </article>
                }
            </div>
        }
        <hr />
        <div class="ec-grid">
            @foreach (var cb in callbaks.OrderByDescending(x => x.Id))
            {
                <article class="ec-entry">
                    <div class="ec-entry__top">
                        <span class="ec-badge ec-badge--callback">CALL BACK</span>

                        <div class="ec-date">
                            <div class="ec-date__d">@cb.CreatedUtc.ToString("dd.MM.yyyy")</div>
                        </div>
                    </div>

                    <div class="ec-entry__body">
                        <div class="ec-client">
                            <div class="ec-client__name">@cb.Name</div>

                            @if (!string.IsNullOrWhiteSpace(cb.Phone))
                            {
                                <a class="ec-client__phone" href="tel:@cb.Phone">@cb.Phone</a>
                            }
                        </div>

                        <div class="ec-proc">
                            <div class="ec-proc__title">Заявка на дзвінок</div>

                            @if (!string.IsNullOrWhiteSpace(cb.Comment))
                            {
                                <div class="ec-proc__desc">@cb.Comment</div>
                            }
                            else
                            {
                                <div class="ec-proc__desc text-muted">—</div>
                            }
                        </div>
                    </div>

                    <div class="ec-entry__bottom">
                        <div class="ec-price">
                            <span class="text-muted">—</span>
                        </div>

                        <button class="btn btn-outline-danger btn-sm rounded-pill d-inline-flex align-items-center gap-1"
                                title="Видалити"
                                disabled="@deletingCallback.Contains(cb.Id)"
                                @onclick="() => ConfirmAndDeleteCallbackAsync(cb)">
                            <i class="fa-solid fa-trash" aria-hidden="true"></i>
                            <span>@(deletingCallback.Contains(cb.Id) ? "Видаляю..." : "Видалити")</span>
                        </button>
                    </div>
                </article>
            }
        </div>
    </section>
</main>




@code {
    private List<Appointment> rows = new();
    private List<CallbackRequest> callbaks = new();
    private List<ServiceClient> serviceLists = new();
    private static readonly CultureInfo ua = new("uk-UA");
    private readonly HashSet<int> deleting = new();

    protected override async Task OnInitializedAsync()
    {
        rows = await _clientService.GetAllAppointmentAsync();
        serviceLists = await _clientService.GetServiceAsync();
        callbaks = await _telegramBotService.GetAllCallbackAsync();
    }

    private async Task ConfirmAndDeleteAsync(CalendarRowDto row)
    {
        if (row is null) return;

        var message =
            $"Ви дійсно хочете видалити запис?\n\n" +
            $"Клієнт: {row.ClientName}\n" +
            $"Дата: {row.Date:dd.MM.yyyy}\n\n" +
            $"❗ Цю дію неможливо скасувати.";

        var confirmed = await JS.InvokeAsync<bool>("confirm", message);
        if (!confirmed) return;

        deleting.Add(row.Id);
        try
        {
            await _clientService.DeleteAppointmentAsync(row.Id);
            rows.RemoveAll(r => r.Id == row.Id);
            StateHasChanged();
        }
        finally
        {
            deleting.Remove(row.Id);
        }
    }

    private CalendarRowDto MapToCalendarRowDto(Appointment appointment)
    {      
        var svc = serviceLists
            .Where(s => s.Id == appointment.ServiceId)
            .OrderBy(s => s.Id)
            .FirstOrDefault();

        return new CalendarRowDto
        {
            Id = appointment.Id,
            Date = appointment.AppointmentDate,
            ClientName = appointment.ClientName,
            ClientPhone = appointment.ClientPhone,
            Group = appointment.Group,

            TitleCard = svc?.TitleCard ?? appointment.ServiceTitle ?? "",
            DescriptionCard = svc?.DescriptionCard ?? appointment.Message ?? "",
            Price = (decimal?)svc?.Price
        };
    }

    private readonly HashSet<int> deletingCallback = new();

    private async Task ConfirmAndDeleteCallbackAsync(CallbackRequest cb)
    {
        if (cb is null) return;

        var message =
            $"Видалити запит на дзвінок?\n\n" +
            $"Клієнт: {cb.Name}\n" +
            $"Телефон: {cb.Phone}\n\n" +
            $"❗ Цю дію неможливо скасувати.";

        var confirmed = await JS.InvokeAsync<bool>("confirm", message);
        if (!confirmed) return;

        deletingCallback.Add(cb.Id);
        try
        {
            await _telegramBotService.DeleteServiceAsync(cb.Id);
            callbaks.RemoveAll(x => x.Id == cb.Id);
            StateHasChanged();
        }
        finally
        {
            deletingCallback.Remove(cb.Id);
        }
    }

}
