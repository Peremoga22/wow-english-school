@page "/edit-admin-service"
@page "/edit-admin-service/{Id:int}"

@inject ClientService _clientService
@inject IWebHostEnvironment _env
@inject NavigationManager _navigationManager
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<div class="container my-4">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-1">
                @(IsEdit ? "Редагування послуги" : "Додавання послуг")
            </h3>
            <p class="text-muted mb-0 small">
                Картка послуги/курсу: назва, опис, фото, час, вік, група, ціна, культура
            </p>
        </div>

        <div class="ec-actions">
            <button type="button"
                    class="btn ec-btn-primary ec-btn-action"
                    @onclick="GoBack"
                    disabled="@isSaving">
                <i class="bi bi-arrow-left me-1"></i>
                Назад
            </button>

            <button type="submit"
                    form="serviceForm"
                    class="btn ec-btn-primary ec-btn-action"
                    disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"> Збереження...</span>
                   
                }
                else
                {
                    <i class="bi bi-check2-circle me-1"> Зберегти</i>
                   
                }
            </button>

            @if (Id > 0)
            {
                <button type="button"
                        class="btn ec-btn-danger-outline ec-btn-action ec-btn-danger"
                        @onclick="() => DeleteCardAsync(Id ?? 0)"
                        disabled="@isSaving">
                    <i class="bi bi-trash me-1"></i>
                    Видалити
                </button>
            }
        </div>

    </div>

    <!-- Card -->
    <div class="bg-white shadow-sm rounded-4 p-3 p-md-4">

        @if (loadError is not null)
        {
            <div class="alert alert-danger rounded-4">
                <b>Помилка:</b> @loadError
            </div>
        }

        <EditForm id="serviceForm" Model="@model" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-4">

                <!-- Left: Image -->
                <div class="col-12 col-lg-5">
                    <div class="border rounded-4 p-3 h-100">

                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <div class="fw-semibold">Фото картки</div>
                                <div class="text-muted small">
                                    @(model.IsCulture ? "English version (IsCulture=true)" : "Українська версія (IsCulture=false)")
                                </div>
                            </div>

                            <div class="form-check form-switch">
                                <InputCheckbox class="form-check-input" @bind-Value="model.IsCulture" />
                                <label class="form-check-label small">
                                    IsCulture
                                </label>
                            </div>
                        </div>

                        <!-- Preview (single block, no duplicates) -->
                        <div class="ratio ratio-16x9 rounded-4 overflow-hidden bg-light border">
                            @if (!string.IsNullOrWhiteSpace(PreviewUrl))
                            {
                                <img src="@PreviewUrl"
                                     class="w-100 h-100 object-fit-cover"
                                     alt="Preview"
                                     loading="lazy" />
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center px-3">
                                        <i class="bi bi-image fs-2 d-block mb-2"></i>
                                        <div class="small">Немає фото — завантаж його нижче</div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-3">
                            <InputFile OnChange="OnFileSelected" accept="image/*" class="form-control" />
                            <div class="text-muted small mt-2">
                                Порада: JPG/PNG/WebP, до ~5MB.
                            </div>

                            @if (selectedFile is not null)
                            {
                                <div class="alert alert-info rounded-4 small mt-3 mb-0">
                                    <b>Обрано:</b> @selectedFile.OriginalName
                                    <span class="text-muted">(@(Math.Round(selectedFile.Size / 1024.0, 1)) KB)</span>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                                            @onclick="ClearSelectedFile">
                                        Прибрати
                                    </button>
                                </div>
                            }
                        </div>

                    </div>
                </div>

                <!-- Right: Fields -->
                <div class="col-12 col-lg-7">
                    <div class="row g-3">

                        <div class="col-12">
                            <label class="form-label fw-semibold">@T("Назва", "Title")</label>
                            <InputText class="form-control" @bind-Value="model.TitleCard"
                                       placeholder="@T("Напр. Kids English", "e.g., Kids English")" />
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-semibold">@T("Опис", "Description")</label>
                            <InputTextArea class="form-control" rows="4"
                                           @bind-Value="model.DescriptionCard"
                                           placeholder="@T("Коротко про сервіс/курс...", "Short description of the service/course...")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Час заняття", "Lesson time")</label>
                            <InputText class="form-control" @bind-Value="model.LessonTime"
                                       placeholder="@T("Напр. 45 хв", "e.g., 45 min")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Вік учня", "Student age")</label>
                            <InputNumber class="form-control" @bind-Value="model.AgeOfStudent" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Група", "Group")</label>
                            <InputText class="form-control" @bind-Value="model.Group"
                                       placeholder="@T("Напр. Beginner", "e.g., Beginner")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Ціна", "Price")</label>
                            <InputNumber class="form-control" @bind-Value="model.Pice" />
                        </div>
                                               
                    </div>
                </div>

            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }

    private bool IsEdit => Id.HasValue && Id.Value > 0;       
    private ServiceClient model = new();
    private string? loadError;
    private bool isSaving;
    private PreparedUploadFile? selectedFile;
    private string? ErrorMessage;
    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (IsEdit)
            {
                var fromDb = await _clientService.GetServiceByIdAsync(Id!.Value);

                if (fromDb is null)
                {
                    loadError = "Не знайдено запис для редагування.";
                    return;
                }

                model = fromDb;
            }
            else
            {
                // defaults
                model = new ServiceClient
                {
                    IsCulture = false
                };
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }
       
    private string? PreviewUrl
    {
        get
        {            
            if (!string.IsNullOrWhiteSpace(selectedFile?.DataUrl))
                return selectedFile!.DataUrl;
                            
            if (string.IsNullOrWhiteSpace(model.ImgPath))
                return null;
           
            return model.ImgPath.StartsWith("/")
                ? model.ImgPath
                : "/" + model.ImgPath.TrimStart('/');
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file is null) return;
               
        const long maxBytes = 5 * 1024 * 1024;
             
        using var stream = file.OpenReadStream(maxBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var bytes = ms.ToArray();
        if (bytes.Length == 0)
        {
            selectedFile = null;
            return;
        }

        var base64 = Convert.ToBase64String(bytes);
        var dataUrl = $"data:{file.ContentType};base64,{base64}";

        selectedFile = new PreparedUploadFile(
            OriginalName: file.Name,
            ContentType: file.ContentType,
            Size: file.Size,
            Bytes: bytes,
            DataUrl: dataUrl
        );
    }

    private void ClearSelectedFile() => selectedFile = null;

    private async Task SaveAsync()
    {
        if (isSaving) return;

        isSaving = true;
        loadError = null;

        try
        {            
            if (selectedFile is not null)
            {
                var relative = await SaveImageToWwwRootAsync(selectedFile);
                model.ImgPath = relative; 
            }
                      
            await _clientService.SaveServiceAsync(model);                      
            _navigationManager.NavigateTo("/admin-services");
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task<string> SaveImageToWwwRootAsync(PreparedUploadFile file)
    {        
        var uploadsDir = Path.Combine(_env.WebRootPath, "uploads", "services");
        Directory.CreateDirectory(uploadsDir);
                
        var ext = GetSafeImageExtension(file.ContentType);
        var name = $"{Guid.NewGuid():N}{ext}";
        var fullPath = Path.Combine(uploadsDir, name);

        await File.WriteAllBytesAsync(fullPath, file.Bytes);
               
        return $"uploads/services/{name}";
    }

    private static string GetSafeImageExtension(string? contentType)
        => contentType?.ToLowerInvariant() switch
        {
            "image/png" => ".png",
            "image/webp" => ".webp",
            "image/gif" => ".gif",
            _ => ".jpg"
        };

    private void GoBack() => _navigationManager.NavigateTo("/admin-services");
       
    private string T(string uk, string en) => model.IsCulture ? en : uk;

    private sealed record PreparedUploadFile(
        string OriginalName,
        string ContentType,
        long Size,
        byte[] Bytes,
        string DataUrl
    );

    private void DeletePhysicalIfExists(string? webPath)
    {
        if (string.IsNullOrWhiteSpace(webPath)) return;
        if (webPath == "is video") return;

        var webRoot = _env.WebRootPath ?? "";
        if (string.IsNullOrWhiteSpace(webRoot)) return;

        var relative = webPath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
        var physical = Path.Combine(webRoot, relative);

        if (System.IO.File.Exists(physical))
            System.IO.File.Delete(physical);
    }

    private async Task DeleteCardAsync(int Id)
    {
        try
        {
            DeletePhysicalIfExists(model.ImgPath);           

            await _clientService.DeleteServiceAsync(Id);
            _navigationManager.NavigateTo("/admin-services");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Помилка при видаленні: {ex.Message}";
        }
    }
}
