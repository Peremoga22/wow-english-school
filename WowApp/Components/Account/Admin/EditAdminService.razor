@page "/edit-admin-service"
@page "/edit-admin-service/{Id:int}"

@using SixLabors.ImageSharp
@using SixLabors.ImageSharp.Formats.Jpeg
@using SixLabors.ImageSharp.Processing

@inject ClientService _clientService
@inject IWebHostEnvironment _env
@inject NavigationManager _navigationManager
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<div class="container my-4">

    <!-- Header -->
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
        <div>
            <h3 class="fw-bold text-primary mb-1">
                @(IsEdit ? "Редагування послуги" : "Додавання послуг")
            </h3>
            <p class="text-muted mb-0 small">
                Картка послуги/курсу: назва, опис, фото, час, вік, група, ціна, культура
            </p>
        </div>

        <div class="ec-actions">
            <button type="button"
                    class="btn ec-btn-primary ec-btn-action"
                    @onclick="GoBack"
                    disabled="@isSaving">
                <i class="bi bi-arrow-left me-1"></i>
                Назад
            </button>

            <button type="submit"
                    form="serviceForm"
                    class="btn ec-btn-primary ec-btn-action"
                    disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    <span>Збереження...</span>
                }
                else
                {
                    <i class="bi bi-check2-circle me-1"></i>
                    <span>Зберегти</span>
                }
            </button>

            @if (Id > 0)
            {
                <button type="button"
                        class="btn ec-btn-danger-outline ec-btn-action ec-btn-danger"
                        @onclick="() => DeleteCardAsync(Id ?? 0)"
                        disabled="@isSaving">
                    <i class="bi bi-trash me-1"></i>
                    Видалити
                </button>
            }
        </div>
    </div>

    <!-- Card -->
    <div class="bg-white shadow-sm rounded-4 p-3 p-md-4">

        @if (!string.IsNullOrWhiteSpace(loadError))
        {
            <div class="alert alert-danger rounded-4">
                <b>Помилка:</b> @loadError
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <div class="alert alert-warning rounded-4">
                <b>Увага:</b> @ErrorMessage
            </div>
        }

        <EditForm id="serviceForm" Model="@model" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-4">

                <!-- Left: Image -->
                <div class="col-12 col-lg-5">
                    <div class="border rounded-4 p-3 h-100">

                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <div class="fw-semibold">Фото картки</div>
                                <div class="text-muted small">
                                    @(model.IsCulture ? "English version (IsCulture=true)" : "Українська версія (IsCulture=false)")
                                </div>
                            </div>

                            <div class="form-check form-switch">
                                <InputCheckbox class="form-check-input" @bind-Value="model.IsCulture" />
                                <label class="form-check-label small">
                                    IsCulture
                                </label>
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="ratio ratio-16x9 rounded-4 overflow-hidden bg-light border">
                            @if (!string.IsNullOrWhiteSpace(PreviewUrl))
                            {
                                <img src="@PreviewUrl"
                                     class="w-100 h-100 object-fit-cover"
                                     alt="Preview"
                                     loading="lazy" />
                            }
                            else
                            {
                                <div class="d-flex align-items-center justify-content-center text-muted">
                                    <div class="text-center px-3">
                                        <i class="bi bi-image fs-2 d-block mb-2"></i>
                                        <div class="small">Немає фото — завантаж його нижче</div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="mt-3">
                            <InputFile OnChange="OnFileSelected" accept="image/*" class="form-control" />

                            <div class="mt-3">
                                <div class="fw-semibold small mb-2">Стиснення (вага файлу після збереження)</div>

                                <InputRadioGroup @bind-Value="TargetKb" class="d-flex flex-wrap gap-3">
                                    <label class="form-check d-flex align-items-center gap-2 mb-0">
                                        <InputRadio class="form-check-input" Value="300" />
                                        <span class="small">300 KB</span>
                                    </label>

                                    <label class="form-check d-flex align-items-center gap-2 mb-0">
                                        <InputRadio class="form-check-input" Value="500" />
                                        <span class="small">500 KB</span>
                                    </label>
                                </InputRadioGroup>

                                <div class="text-muted small mt-2">
                                    Можна завантажувати фото будь-якого розміру. Під час збереження я автоматично
                                    зменшу вагу (і при потребі розмір) до вибраного ліміту.
                                </div>
                            </div>

                            @if (selectedFile is not null)
                            {
                                <div class="alert alert-info rounded-4 small mt-3 mb-0">
                                    <b>Обрано:</b> @selectedFile.OriginalName
                                    <span class="text-muted">(@(Math.Round(selectedFile.Size / 1024.0, 1)) KB)</span>
                                    <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                                            @onclick="ClearSelectedFile">
                                        Прибрати
                                    </button>
                                </div>
                            }
                        </div>

                    </div>
                </div>

                <!-- Right: Fields -->
                <div class="col-12 col-lg-7">
                    <div class="row g-3">

                        <div class="col-12">
                            <label class="form-label fw-semibold">@T("Назва", "Title")</label>
                            <InputText class="form-control" @bind-Value="model.TitleCard"
                                       placeholder="@T("Напр. Kids English", "e.g., Kids English")" />
                        </div>

                        <div class="col-12">
                            <label class="form-label fw-semibold">@T("Опис", "Description")</label>
                            <InputTextArea class="form-control" rows="4"
                                           @bind-Value="model.DescriptionCard"
                                           placeholder="@T("Коротко про сервіс/курс...", "Short description of the service/course...")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Час заняття", "Lesson time")</label>
                            <InputText class="form-control" @bind-Value="model.LessonTime"
                                       placeholder="@T("Напр. 45 хв", "e.g., 45 min")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Вік учня", "Student age")</label>
                            <InputNumber class="form-control" @bind-Value="model.AgeOfStudent" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Група", "Group")</label>
                            <InputText class="form-control" @bind-Value="model.Group"
                                       placeholder="@T("Напр. Beginner", "e.g., Beginner")" />
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-semibold">@T("Ціна", "Price")</label>
                            <InputNumber class="form-control" @bind-Value="model.Pice" />
                        </div>

                    </div>
                </div>

            </div>
        </EditForm>
    </div>
</div>

@code {
    [Parameter] public int? Id { get; set; }

    private bool IsEdit => Id.HasValue && Id.Value > 0;
    private ServiceClient model = new();
    private string? loadError;
    private bool isSaving;
    private PreparedUploadFile? selectedFile;
    private string? ErrorMessage;

    // 300 або 500 KB (за замовчуванням 500)
    private int TargetKb { get; set; } = 500;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (IsEdit)
            {
                var fromDb = await _clientService.GetServiceByIdAsync(Id!.Value);

                if (fromDb is null)
                {
                    loadError = "Не знайдено запис для редагування.";
                    return;
                }

                model = fromDb;
            }
            else
            {
                model = new ServiceClient { IsCulture = false };
            }
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
    }

    private string? PreviewUrl
    {
        get
        {
            if (!string.IsNullOrWhiteSpace(selectedFile?.DataUrl))
                return selectedFile!.DataUrl;

            if (string.IsNullOrWhiteSpace(model.ImgPath))
                return null;

            return model.ImgPath.StartsWith("/")
                ? model.ImgPath
                : "/" + model.ImgPath.TrimStart('/');
        }
    }

    private async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        ErrorMessage = null;

        var file = e.File;
        if (file is null) return;

        // Даємо завантажувати великі фото, але все одно ставимо "захисний" ліміт, щоб не вбити сервер
        const long hardLimitBytes = 50 * 1024 * 1024; // 50MB
        if (file.Size > hardLimitBytes)
        {
            selectedFile = null;
            ErrorMessage = "Файл занадто великий (понад 50MB). Завантаж менший.";
            return;
        }

        using var stream = file.OpenReadStream(hardLimitBytes);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        var bytes = ms.ToArray();
        if (bytes.Length == 0)
        {
            selectedFile = null;
            ErrorMessage = "Не вдалося прочитати файл (0 bytes).";
            return;
        }

        // Preview може бути важким для дуже великих фото, але працює стабільно.
        var base64 = Convert.ToBase64String(bytes);
        var dataUrl = $"data:{file.ContentType};base64,{base64}";

        selectedFile = new PreparedUploadFile(
            OriginalName: file.Name,       // реальна назва файлу
            ContentType: file.ContentType,
            Size: file.Size,
            Bytes: bytes,
            DataUrl: dataUrl
        );
    }

    private void ClearSelectedFile()
    {
        selectedFile = null;
        ErrorMessage = null;
    }

    private async Task SaveAsync()
    {
        if (isSaving) return;

        isSaving = true;
        loadError = null;
        ErrorMessage = null;

        try
        {
            if (selectedFile is not null)
            {
                var relative = await SaveImageToWwwRootAsync(selectedFile, TargetKb);
                model.ImgPath = relative;
            }

            await _clientService.SaveServiceAsync(model);
            _navigationManager.NavigateTo("/admin-services");
        }
        catch (Exception ex)
        {
            loadError = ex.Message;
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task<string> SaveImageToWwwRootAsync(PreparedUploadFile file, int targetKb)
    {
        var uploadsDir = Path.Combine(_env.WebRootPath, "uploads", "services");
        Directory.CreateDirectory(uploadsDir);

        // Стискаємо до targetKb (300/500 KB). Вихід робимо JPG (найкраще для фото).
        var targetBytes = Math.Max(50, targetKb) * 1024; // захист від 0/дурних значень
        var compressed = await CompressToJpegTargetAsync(file.Bytes, targetBytes);

        var name = $"{Guid.NewGuid():N}.jpg";
        var fullPath = Path.Combine(uploadsDir, name);

        await System.IO.File.WriteAllBytesAsync(fullPath, compressed);

        return $"uploads/services/{name}";
    }

    /// <summary>
    /// Стискання: 1) обмежуємо розмір по довгій стороні, 2) підбираємо quality, 3) якщо не влазить — зменшуємо розміри ще.
    /// </summary>
    private static async Task<byte[]> CompressToJpegTargetAsync(byte[] inputBytes, int targetBytes)
    {
        using var ms = new MemoryStream(inputBytes);
        using var image = await Image.LoadAsync(ms);

        // 1) Спершу нормальний "web" розмір (щоб не зберігати 6000x4000)
        const int maxSide = 1920;
        image.Mutate(ctx => ctx.AutoOrient()); // правильна орієнтація

        if (image.Width > maxSide || image.Height > maxSide)
        {
            var ratio = Math.Min((double)maxSide / image.Width, (double)maxSide / image.Height);
            var w = Math.Max(1, (int)Math.Round(image.Width * ratio));
            var h = Math.Max(1, (int)Math.Round(image.Height * ratio));

            image.Mutate(ctx => ctx.Resize(w, h));
        }

        // 2) Підбір якості
        var quality = 90;
        var minQuality = 40;

        while (true)
        {
            var bytes = EncodeJpeg(image, quality);
            if (bytes.Length <= targetBytes)
                return bytes;

            // якщо вже впали до мінімальної якості — зменшуємо розміри ще
            if (quality <= minQuality)
            {
                // зменшення розміру на 15%
                var w2 = Math.Max(1, (int)Math.Round(image.Width * 0.85));
                var h2 = Math.Max(1, (int)Math.Round(image.Height * 0.85));

                // якщо вже нікуди зменшувати — повертаємо, що вийшло (краще ніж впасти)
                if (w2 >= image.Width || h2 >= image.Height || w2 < 200 || h2 < 200)
                    return bytes;

                image.Mutate(ctx => ctx.Resize(w2, h2));
                quality = 90; // після ресайзу пробуємо знову з високої якості
                continue;
            }

            quality -= 5;
        }
    }

    private static byte[] EncodeJpeg(Image image, int quality)
    {
        using var ms = new MemoryStream();
        var encoder = new JpegEncoder
        {
            Quality = quality
        };
        image.Save(ms, encoder);
        return ms.ToArray();
    }

    private void GoBack() => _navigationManager.NavigateTo("/admin-services");

    private string T(string uk, string en) => model.IsCulture ? en : uk;

    private sealed record PreparedUploadFile(
        string OriginalName,
        string ContentType,
        long Size,
        byte[] Bytes,
        string DataUrl
    );

    private void DeletePhysicalIfExists(string? webPath)
    {
        if (string.IsNullOrWhiteSpace(webPath)) return;
        if (webPath == "is video") return;

        var webRoot = _env.WebRootPath ?? "";
        if (string.IsNullOrWhiteSpace(webRoot)) return;

        var relative = webPath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
        var physical = Path.Combine(webRoot, relative);

        if (System.IO.File.Exists(physical))
            System.IO.File.Delete(physical);
    }

    private async Task DeleteCardAsync(int Id)
    {
        try
        {
            DeletePhysicalIfExists(model.ImgPath);

            await _clientService.DeleteServiceAsync(Id);
            _navigationManager.NavigateTo("/admin-services");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Помилка при видаленні: {ex.Message}";
        }
    }
}
