@page "/edit-admin-home"
@page "/edit-admin-home/{Id:int}"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@inject ApplicationDbContext Db
@inject ImageService ImageStore
@inject NavigationManager Nav

@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<PageTitle>Admin Edit Home</PageTitle>

<div class="container my-4">

    <!-- Page title -->
    <div class="d-flex flex-column flex-md-row align-items-md-end justify-content-between gap-3 mb-4">
        <div>
            <h3 class="fw-bold mb-1">
                @(Id == 0 ? "Додавання картки контенту" : "Редагування картки контенту")
            </h3>
            <p class="text-muted mb-0 small">
                Керування фото/текстами та мовною версією
            </p>
        </div>

        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-outline-secondary rounded-pill px-3" @onclick="BackToList">
                <i class="bi bi-arrow-left me-1"></i> Назад
            </button>
        </div>
    </div>

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="bg-white shadow-sm rounded-4 px-3 px-md-4 py-3 mb-4">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <a class="text-decoration-none" href="javascript:void(0)" @onclick="BackToList">
                    <i class="bi bi-house-door me-1"></i> Адмін-панель
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                Домашня сторінка — @(Id == 0 ? "додати" : "редагувати")
            </li>
        </ol>
    </nav>

    @if (loading)
    {
        <div class="text-muted">Завантаження...</div>
    }
    else
    {
        <EditForm Model="form" OnValidSubmit="SaveAsync">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="row g-4">
                <!-- LEFT: Form -->
                <div class="col-lg-6">
                    <div class="p-3 border rounded-4 bg-white shadow-sm">

                        <!-- Culture -->
                        <div class="border rounded-4 p-3 bg-light mb-3">
                            <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                                <div>
                                    <div class="fw-semibold">Мовна версія запису</div>
                                    <div class="text-muted small">EN = увімкни перемикач і заповни англійською.</div>
                                </div>

                                <div class="form-check form-switch m-0">
                                    <InputCheckbox class="form-check-input" id="IsCulture" @bind-Value="form.IsCulture" />
                                    <label class="form-check-label fw-semibold" for="IsCulture">EN</label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Заголовок</label>
                            <InputText class="form-control" @bind-Value="form.PhotoTitle" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Текст</label>
                            <InputTextArea class="form-control" rows="4" @bind-Value="form.PhotoText" />
                        </div>

                        <hr />

                        <h6 class="mb-2">3 фото</h6>

                        <div class="mb-3">
                            <label class="form-label">Фото зліва</label>
                            <InputFile OnChange="e => OnPickAsync(0, e)" accept="image/*" />
                            <div class="small text-muted mt-1">png/jpg/webp</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Фото по центру</label>
                            <InputFile OnChange="e => OnPickAsync(1, e)" accept="image/*" />
                            <div class="small text-muted mt-1">png/jpg/webp</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Фото справа</label>
                            <InputFile OnChange="e => OnPickAsync(2, e)" accept="image/*" />
                            <div class="small text-muted mt-1">png/jpg/webp</div>
                        </div>

                        <hr />

                        <h6 class="mb-2">Різдвяний блок</h6>

                        <div class="mb-3">
                            <label class="form-label">Заголовок</label>
                            <InputText class="form-control" @bind-Value="form.ChristmasTitle" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Текст</label>
                            <InputTextArea class="form-control" rows="4" @bind-Value="form.ChristmasText" />
                        </div>

                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-primary rounded-pill px-4" type="submit" disabled="@saving">
                                @(saving ? "Збереження..." : "Зберегти")
                            </button>

                            <button type="button" class="btn btn-outline-secondary rounded-pill px-4" @onclick="BackToList">
                                Скасувати
                            </button>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(msg))
                        {
                            <div class="alert alert-info mt-3 mb-0">@msg</div>
                        }
                    </div>
                </div>

                <!-- RIGHT: Preview -->
                <div class="col-lg-6">
                    <div class="p-3 border rounded-4 bg-white shadow-sm">
                        <div class="small text-muted mb-2">Preview</div>

                        <div class="ec-photo-middle mb-3">
                            <img src="@GetPreviewOrSaved(0)" class="ec-photo ec-photo-side" alt="left" />
                            <img src="@GetPreviewOrSaved(1)" class="ec-photo ec-photo-center" alt="center" />
                            <img src="@GetPreviewOrSaved(2)" class="ec-photo ec-photo-side" alt="right" />
                        </div>

                        <div class="text-center">
                            <h3 class="ec-photo-title mb-2">@form.PhotoTitle</h3>
                            <p class="ec-photo-text mb-0">@form.PhotoText</p>
                        </div>

                        <div class="mt-4 text-center">
                            <div class="ec-christmas-icon">🎄</div>
                            <h3 class="ec-christmas-title">@form.ChristmasTitle</h3>
                            <p class="ec-christmas-text">@form.ChristmasText</p>
                        </div>
                    </div>
                </div>
            </div>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int Id { get; set; } // 0=create, >0=edit

    private bool loading = true;
    private bool saving = false;
    private string? msg;

    private HomeSectionEditVm form = new();
    private HomeSection? entity;

    private IBrowserFile?[] picked = new IBrowserFile?[3];
    private string?[] preview = new string?[3];

    protected override async Task OnParametersSetAsync()
    {
        loading = true;
        msg = null;

        if (Id == 0)
        {
            entity = null;
            form = new HomeSectionEditVm();
        }
        else
        {
            entity = await Db.HomeSections.AsNoTracking().FirstOrDefaultAsync(x => x.Id == Id);
            if (entity is null)
            {
                // якщо відкрили неіснуючий id
                Id = 0;
                form = new HomeSectionEditVm();
            }
            else
            {
                form = new HomeSectionEditVm
                {
                    PhotoTitle = entity.PhotoTitle,
                    PhotoText = entity.PhotoText,
                    ChristmasTitle = entity.ChristmasTitle,
                    ChristmasText = entity.ChristmasText,
                    ImgLeftPath = entity.ImgLeftPath,
                    ImgCenterPath = entity.ImgCenterPath,
                    ImgRightPath = entity.ImgRightPath,
                    IsCulture = entity.IsCulture
                };
            }
        }

        loading = false;
    }

    private void BackToList()
    {
        // forceLoad=true — гарантовано працює на хостингах/підпапках/коли NavLink “чомусь” не клікається
        Nav.NavigateTo("/admin-home", forceLoad: true);
    }

    private string GetPreviewOrSaved(int idx)
    {
        if (!string.IsNullOrWhiteSpace(preview[idx]))
            return preview[idx]!;

        return idx switch
        {
            0 => string.IsNullOrWhiteSpace(form.ImgLeftPath) ? "/images/placeholder.jpg" : form.ImgLeftPath!,
            1 => string.IsNullOrWhiteSpace(form.ImgCenterPath) ? "/images/placeholder.jpg" : form.ImgCenterPath!,
            2 => string.IsNullOrWhiteSpace(form.ImgRightPath) ? "/images/placeholder.jpg" : form.ImgRightPath!,
            _ => "/images/placeholder.jpg"
        };
    }

    private async Task OnPickAsync(int idx, InputFileChangeEventArgs e)
    {
        msg = null;
        var file = e.File;
        if (file is null) return;

        picked[idx] = file;
        preview[idx] = await ToDataUrlAsync(file, maxBytes: 600_000);
    }

    private async Task SaveAsync()
    {
        saving = true;
        msg = null;

        try
        {
            if (Id > 0)
                entity = await Db.HomeSections.FirstOrDefaultAsync(x => x.Id == Id);

            if (entity is null)
            {
                entity = new HomeSection
                {
                    PhotoTitle = form.PhotoTitle,
                    PhotoText = form.PhotoText,
                    ChristmasTitle = form.ChristmasTitle,
                    ChristmasText = form.ChristmasText,
                    IsCulture = form.IsCulture,
                    CreatedAtUtc = DateTime.UtcNow,
                    UpdatedAtUtc = DateTime.UtcNow
                };

                Db.HomeSections.Add(entity);
            }
            else
            {
                entity.PhotoTitle = form.PhotoTitle;
                entity.PhotoText = form.PhotoText;
                entity.ChristmasTitle = form.ChristmasTitle;
                entity.ChristmasText = form.ChristmasText;
                entity.IsCulture = form.IsCulture;
                entity.UpdatedAtUtc = DateTime.UtcNow;
            }

            if (picked[0] is not null)
            {
                await ReplaceImageAsync(entity.ImgLeftPath, v => entity.ImgLeftPath = v, picked[0]!, "uploads/home");
                form.ImgLeftPath = entity.ImgLeftPath;
                picked[0] = null; preview[0] = null;
            }

            if (picked[1] is not null)
            {
                await ReplaceImageAsync(entity.ImgCenterPath, v => entity.ImgCenterPath = v, picked[1]!, "uploads/home");
                form.ImgCenterPath = entity.ImgCenterPath;
                picked[1] = null; preview[1] = null;
            }

            if (picked[2] is not null)
            {
                await ReplaceImageAsync(entity.ImgRightPath, v => entity.ImgRightPath = v, picked[2]!, "uploads/home");
                form.ImgRightPath = entity.ImgRightPath;
                picked[2] = null; preview[2] = null;
            }

            await Db.SaveChangesAsync();

            // якщо це було створення — оновлюємо роут на /edit-admin-home/{id}
            if (Id == 0 && entity.Id > 0)
            {
                Id = entity.Id;
                Nav.NavigateTo($"/edit-admin-home/{Id}", replace: true);
            }

            msg = "✅ Збережено!";
        }
        catch (Exception ex)
        {
            msg = "❌ Помилка: " + ex.Message;
        }
        finally
        {
            saving = false;
        }
    }

    private async Task ReplaceImageAsync(string? oldPath, Action<string> setNew, IBrowserFile file, string folder)
    {
        var newPath = await ImageStore.SaveCompressedAsync(file, folder, maxWidth: 1600, quality: 75);
        setNew(newPath);

        if (!string.IsNullOrWhiteSpace(oldPath) &&
            oldPath.StartsWith("/uploads/", StringComparison.OrdinalIgnoreCase))
        {
            await ImageStore.DeleteIfExistsAsync(oldPath);
        }
    }

    private static async Task<string> ToDataUrlAsync(IBrowserFile file, int maxBytes)
    {
        var size = (int)Math.Min(file.Size, maxBytes);
        using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024);

        var buffer = new byte[size];
        var read = 0;

        while (read < size)
        {
            var n = await stream.ReadAsync(buffer.AsMemory(read, size - read));
            if (n == 0) break;
            read += n;
        }

        var base64 = Convert.ToBase64String(buffer, 0, read);
        return $"data:{file.ContentType};base64,{base64}";
    }

    public class HomeSectionEditVm
    {
        public string PhotoTitle { get; set; } = "";
        public string PhotoText { get; set; } = "";

        public string? ChristmasTitle { get; set; }
        public string? ChristmasText { get; set; }

        public string? ImgLeftPath { get; set; }
        public string? ImgCenterPath { get; set; }
        public string? ImgRightPath { get; set; }

        public bool IsCulture { get; set; }
    }
}
