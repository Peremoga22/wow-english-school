@page "/admin-portfolio"

@inject NavigationManager Nav
@inject PortfolioService PortfolioService
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

<div class="container my-4">

    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row align-items-lg-end justify-content-between gap-3 mb-4">
        <div>
            <h3 class="fw-bold mb-1">Наповнення сторінки портфоліо</h3>
            <p class="text-muted mb-0 small">Керування титульним блоком та візуальним наповненням</p>
        </div>

        <div class="d-flex gap-2 flex-wrap">
            <a class="btn btn-outline-secondary rounded-pill px-3"
               href="/admin">
                <i class="bi bi-house-door me-1"></i> Адмін-панель
            </a>

            <!-- Add new (culture-aware) -->
            <NavLink class="btn ec-btn-primary rounded-pill px-4"
                     href="@($"/edit-admin-portfolio?culture={(selectedCulture == Culture.En ? "en" : "uk")}")">
                <i class="bi bi-plus-lg me-1"></i>
                <span>Додати</span>
                <span class="opacity-75 ms-1">(@(selectedCulture == Culture.En ? "EN" : "UA"))</span>
            </NavLink>
        </div>
    </div>

    <!-- Culture switch (IsCulture) -->
    <div class="bg-white border rounded-4 p-3 p-md-4 shadow-sm mb-4">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div class="d-flex align-items-center gap-2">
                <span class="badge text-bg-light border rounded-pill px-3 py-2">
                    <i class="bi bi-translate me-1"></i> Мова записів
                </span>

                <div class="btn-group" role="group" aria-label="Culture">
                    <button type="button"
                            class="btn btn-sm @(selectedCulture == Culture.Ua ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetCulture(Culture.Ua)">
                        UA
                    </button>
                    <button type="button"
                            class="btn btn-sm @(selectedCulture == Culture.En ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => SetCulture(Culture.En)">
                        EN
                    </button>
                </div>
            </div>

            <div class="text-muted small">
                Відображаються записи за полем <code>IsCulture</code>:
                <span class="fw-semibold">@((selectedCulture == Culture.En) ? "true (EN)" : "false (UA)")</span>
            </div>
        </div>
    </div>

    <!-- Content -->
    @if (isLoading)
    {
        <div class="bg-white border rounded-4 p-4 shadow-sm">
            <div class="d-flex align-items-center gap-3">
                <div class="spinner-border" role="status"></div>
                <div>
                    <div class="fw-semibold">Завантаження…</div>
                    <div class="text-muted small">Отримуємо записи портфоліо</div>
                </div>
            </div>
        </div>
    }
    else if (filteredList.Count == 0)
    {
        <div class="alert alert-light border rounded-4 shadow-sm mb-0">
            Немає записів для вибраної мови. Натисни <span class="fw-semibold">“Додати”</span>.
        </div>
    }
    else
    {
        <div class="row g-3 g-lg-4">
            @foreach (var item in filteredList)
            {
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100 overflow-hidden">
                        @MediaBlock(item)

                        <div class="card-body d-flex flex-column">
                            <div class="d-flex align-items-start justify-content-between gap-2 mb-2">
                                <h5 class="fw-bold mb-0 text-truncate" title="@item.TitleCard">@item.TitleCard</h5>
                                <span class="badge rounded-pill text-bg-light border">
                                    @(selectedCulture == Culture.En ? "EN" : "UA")
                                </span>
                            </div>

                            <p class="text-muted mb-3" style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;">
                                @item.DescriptionCard
                            </p>

                            <div class="mt-auto d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-2">
                                    <img src="@item.ImgTeacherPath"
                                         alt="Викладач"
                                         class="rounded-circle border"
                                         style="width:36px;height:36px;object-fit:cover;"
                                         onerror="this.style.display='none'" />
                                    <span class="small text-muted">Любов Романівна</span>
                                </div>

                                <NavLink class="btn btn-outline-primary btn-sm rounded-pill px-3"
                                         href="@($"/edit-admin-portfolio/{item.Id}")">
                                    <i class="bi bi-pencil-square me-1"></i> Редагувати
                                </NavLink>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }

</div>

@code {
    private enum Culture { Ua, En }

    private List<Portfolio> allList = new();
    private List<Portfolio> filteredList = new();

    private bool isLoading = true;
    private Culture selectedCulture = Culture.Ua;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        // 1) Load all
        allList = await PortfolioService.GetPortfoliosAsync() ?? new();

        // 2) Default culture (можеш змінити логіку, якщо маєш збереження мови у профілі)
        selectedCulture = Culture.Ua;

        // 3) Apply filter by IsCulture
        FilterCulture();

        isLoading = false;
    }

    private void SetCulture(Culture c)
    {
        selectedCulture = c;
        FilterCulture();
    }

    private void FilterCulture()
    {
        // ВАЖЛИВО: поле IsCulture:
        // false -> UA
        // true  -> EN
        var needIsCulture = selectedCulture == Culture.En;

        filteredList = allList
            .Where(x => x is not null && x.IsCulture == needIsCulture)
            .OrderByDescending(x => x.Id)
            .ToList();
    }

    private RenderFragment MediaBlock(Portfolio item) => @<div>
        @{
            var hasVideo = !string.IsNullOrWhiteSpace(item.VideoPath);
            var label = string.IsNullOrWhiteSpace(item.Group) ? "Portfolio" : item.Group;
        }

        @if (hasVideo)
        {
                <div class="position-relative">
                    <div class="ratio ratio-16x9">
                        <lite-youtube videoid="@item.VideoPath" title="@item.TitleCard"></lite-youtube>
                    </div>
                    <span class="position-absolute top-0 start-0 m-3 badge rounded-pill text-bg-dark bg-opacity-75">
                        @label
                    </span>
                </div>
        }
        else
        {
                <div class="position-relative" style="height: 220px;">
                    <img src="@item.ImgPath"
                         alt="@item.TitleCard"
                         class="w-100 h-100"
                         style="object-fit:cover;"
                         loading="lazy"
                         onerror="this.src='/images/placeholder.jpg';" />

                    <span class="position-absolute top-0 start-0 m-3 badge rounded-pill text-bg-dark bg-opacity-75">
                        @label
                    </span>
                </div>
        }
    </div>;
}
