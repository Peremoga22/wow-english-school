@using System.Globalization
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Http

@using WowApp.Services
@inject IStringLocalizer<App> _localizer
@inject NavigationManager _navigationManager
@inject IJSRuntime _jsRuntime
@inject IAntiforgery _antiforgery
@inject IHttpContextAccessor HttpContextAccessor
@inject CultureStateService _cultureStateService
@rendermode InteractiveServer

<div class="container-fluid position-relative p-0">
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm px-4 px-lg-5 py-3">
        <!-- Logo -->
        <a href="/" class="navbar-brand d-flex align-items-center">
            <img src="images/logo.jpeg" alt="English Club Logo" class="logo-img">
        </a>

        <!-- Mobile Toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
       
        <!-- Navigation -->
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav ms-auto align-items-center gap-2">
                <li class="nav-item">
                    <NavLink href="/" class="nav-link" Match="NavLinkMatch.All" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.HomeHeader
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="/about-us" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                       @SharedResource.AboutUsHeader
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="/reviews" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.ReviewHeader
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="/services-page" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.ServiceHeader
                    </NavLink>
                </li>                          
                <li class="nav-item">
                    <NavLink href="/portfolio" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.PortfolioHeader
                    </NavLink>
                </li> 
                <li class="nav-item">
                    <NavLink href="/contacts" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.ContactHeader
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="/contract" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                        @SharedResource.ContractHeader
                    </NavLink>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center gap-1"
                       href="#"
                       role="button"
                       data-bs-toggle="dropdown">

                        <span>@CurrentFlag</span>
                        <span>@CurrentLang</span>
                    </a>

                    <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                        <li>
                            <button class="dropdown-item @IsActive("uk-UA")"
                                    @onclick="() => ChangeCulture(CultureUa)"
                                    @onclick:stopPropagation="true">
                                🇺🇦 Українська
                            </button>
                        </li>

                        <li>
                            <button class="dropdown-item @IsActive("en-US")"
                                    @onclick="() => ChangeCulture(CultureEn)"
                                    @onclick:stopPropagation="true">
                                🇬🇧 English
                            </button>
                        </li>
                    </ul>
                </li>
             @*    @if (isAuthenticated)
                {
                    <li class="nav-item">
                        <NavLink href="/personal-account" class="nav-link" activeClass="active" @onclick="CloseNavbar">
                            Особистий кабінет
                        </NavLink>
                    </li>
                } *@
                <AuthorizeView>
                    <Authorized Context="auth">
                        @if (auth.User.IsInRole("Admin"))
                        {
                            <li class="nav-item">
                                <NavLink class="nav-link fw-semibold text-primary" href="/admin-clients" @onclick="CloseNavbar">
                                    <i class="bi bi-shield-lock me-1"></i>@SharedResource.AdminHeader
                                </NavLink>
                            </li>
                        }
                        <li class="nav-item">
                            <form action="Account/Logout" method="post" class="d-inline" @onclick="CloseNavbar">
                                <AntiforgeryToken />
                                <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                                <button type="submit" class="nav-link btn-logout">
                                    <i class="bi bi-box-arrow-right me-1"></i>@SharedResource.LogOutHeader
                                </button>
                            </form>
                        </li>
                    </Authorized>

                    <NotAuthorized>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="Account/Login" @onclick="CloseNavbar">
                                <i class="bi bi-person me-1"></i> @SharedResource.LoginHeader
                            </NavLink>
                        </li>
                    </NotAuthorized>
                </AuthorizeView>                
               
            </ul>
        </div>
    </nav>
</div>
<script>
    window.closeNavbar = () => {
        const navbar = document.getElementById('navbarCollapse');
        if (navbar?.classList.contains('show')) {
            bootstrap.Collapse.getOrCreateInstance(navbar).hide();
        }
    };
</script>
@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateUser { get; set; }
    private string? currentUrl;
    private int cartCount;
    private bool isAuthenticated = false;
    private string userName = string.Empty;
    private string CultureUa = "uk-UA";
    private string CultureEn = "en-US";

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateUser;
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var email =
                user.FindFirst(ClaimTypes.Email)?.Value ??
                user.FindFirst("email")?.Value ??
                user.Identity?.Name ?? string.Empty;

            userName = email;
        }
        else
        {
            userName = string.Empty;
        }

        _cultureStateService.OnChange += StateHasChanged;
        currentUrl = _navigationManager.ToBaseRelativePath(_navigationManager.Uri);
    }

    async Task CloseNavbar()
    {
        await _jsRuntime.InvokeVoidAsync("closeNavbar");
    }

    public void Dispose()
    {
        _cultureStateService.OnChange -= StateHasChanged;
    }

    private CultureInfo CurrentCulture => _cultureStateService.CurrentCulture;

    private string CurrentLang =>
        CurrentCulture.TwoLetterISOLanguageName.ToUpper();

    private string CurrentFlag =>
        CurrentCulture.Name switch
        {
            "uk-UA" => "🇺🇦",
            "en-US" => "🇬🇧",
            _ => "🌐"
        };

    private string IsActive(string culture) =>
        CurrentCulture.Name == culture ? "active fw-semibold" : "";

    private void ChangeCulture(string culture)
    {
        // ✅ 1. одразу міняємо UI
        _cultureStateService.SetCulture(culture);

        // ✅ 2. ставимо cookie + reload (реальна культура)
        var url =
            $"/set-culture?culture={culture}&returnUrl={Uri.EscapeDataString(_navigationManager.Uri)}";

        _navigationManager.NavigateTo(url, forceLoad: true);
    }
}
