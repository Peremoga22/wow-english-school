@using System.Globalization
@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Antiforgery
@using Microsoft.AspNetCore.Http
@using WowApp.Services
@inject IStringLocalizer<App> _localizer
@inject NavigationManager _navigationManager
@inject IJSRuntime _jsRuntime
@inject IAntiforgery _antiforgery
@inject IHttpContextAccessor HttpContextAccessor
@inject CultureStateService _cultureStateService


<div class="container-fluid position-relative p-0">
    <nav class="navbar navbar-expand-lg navbar-dark ec-navbar shadow-sm px-4 px-lg-5 py-3">
        <!-- Logo -->
        <a href="/" class="navbar-brand d-flex align-items-center">
            <img src="images/logo.jpeg" alt="English Club Logo" class="logo-img">
        </a>

        <!-- Mobile Toggle -->
        <button class="navbar-toggler text-light fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Navigation -->
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav ms-auto align-items-center gap-2">
                <li class="nav-item">
                    <NavLink href="/admin-clients" class="nav-link text-light fw-bold" Match="NavLinkMatch.All" activeClass="active" @onclick="CloseNavbar">
                        Домашня
                    </NavLink>
                </li>
               @*  <li class="nav-item">
                    <NavLink href="/about-us" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Про нас
                    </NavLink>
                </li>
                <li class="nav-item">
                    <NavLink href="/reviews" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Відгуки
                    </NavLink>
                </li> *@
                <li class="nav-item">
                    <NavLink href="/admin-services" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Послуги
                    </NavLink>
                </li>
              @*   <li class="nav-item">
                    <NavLink href="/contract" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Договір
                    </NavLink>
                </li> *@
                <li class="nav-item">
                    <NavLink href="/admin-portfolio" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Портфоліо
                    </NavLink>
                </li>
               @*  <li class="nav-item">
                    <NavLink href="/contacts" class="nav-link text-light fw-bold" activeClass="active" @onclick="CloseNavbar">
                        Контакти
                    </NavLink>
                </li>   *@                      
                <AuthorizeView>
                    <Authorized Context="auth">
                        <li class="nav-item">
                            <NavLink class="nav-link text-warning fw-bold" href="/">
                                На сайт
                            </NavLink>
                        </li>
                        <li class="nav-item">
                            <form action="Account/Logout" method="post" class="d-inline" @onclick="CloseNavbar">
                                <AntiforgeryToken />
                                <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                                <button type="submit" class="nav-link text-warning fw-bold btn-logout">
                                    <i class="bi bi-box-arrow-right me-1"></i> Вийти
                                </button>
                            </form>
                        </li>
                    </Authorized>
                    <NotAuthorized>
                        <li class="nav-item">
                            <NavLink class="nav-link" href="Account/Login" @onclick="CloseNavbar">
                                <i class="bi bi-person me-1"></i> Логін
                            </NavLink>
                        </li>
                    </NotAuthorized>
                </AuthorizeView>

            </ul>
        </div>
    </nav>
</div>
<script>
    window.closeNavbar = () => {
        const navbar = document.getElementById('navbarCollapse');
        if (navbar?.classList.contains('show')) {
            bootstrap.Collapse.getOrCreateInstance(navbar).hide();
        }
    };
</script>
@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateUser { get; set; }
    private string? currentUrl;
    private int cartCount;
    private bool isAuthenticated = false;
    private string userName = string.Empty;
    private string CultureUa = "uk-UA";
    private string CultureEn = "en-US";

    protected override async Task OnInitializedAsync()
    {
        var authState = await authenticationStateUser;
        var user = authState.User;

        isAuthenticated = user.Identity?.IsAuthenticated ?? false;

        if (isAuthenticated)
        {
            var email =
                user.FindFirst(ClaimTypes.Email)?.Value ??
                user.FindFirst("email")?.Value ??
                user.Identity?.Name ?? string.Empty;

            userName = email;
        }
        else
        {
            userName = string.Empty;
        }

        _cultureStateService.OnChange += StateHasChanged;
        currentUrl = _navigationManager.ToBaseRelativePath(_navigationManager.Uri);
    }

    async Task CloseNavbar()
    {
        await _jsRuntime.InvokeVoidAsync("closeNavbar");
    }

    public void Dispose()
    {
        _cultureStateService.OnChange -= StateHasChanged;
    }

    private CultureInfo CurrentCulture => _cultureStateService.CurrentCulture;

    private string CurrentLang =>
        CurrentCulture.TwoLetterISOLanguageName.ToUpper();

    private string CurrentFlag =>
        CurrentCulture.Name switch
        {
            "uk-UA" => "🇺🇦",
            "en-US" => "🇬🇧",
            _ => "🌐"
        };

    private string IsActive(string culture) =>
        CurrentCulture.Name == culture ? "active fw-semibold" : "";

    private void ChangeCulture(string culture)
    {
        // ✅ 1. одразу міняємо UI
        _cultureStateService.SetCulture(culture);

        // ✅ 2. ставимо cookie + reload (реальна культура)
        var url =
            $"/set-culture?culture={culture}&returnUrl={Uri.EscapeDataString(_navigationManager.Uri)}";

        _navigationManager.NavigateTo(url, forceLoad: true);
    }
}
